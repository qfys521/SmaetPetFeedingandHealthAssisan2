import { PetBean } from '../model/PetBean'
import { PetHealthHistory } from '../model/PetHealthHistoryBean'
import { HttpUtil } from '../tools/HttpUtil'
import { ResponseBean } from '../model/ResponseBean'
import { DataListBean } from '../model/DataListBean'
import { JSON } from '@kit.ArkTS'
import { prompt } from '@kit.ArkUI'

@Component
export struct ProfilePage {
  @State pet: PetBean = new PetBean()
  @State healthList: PetHealthHistory[] = []
  @State isLoading: boolean = false
  @State showEditDialog: boolean = false

  dialogController: CustomDialogController = new CustomDialogController({
    builder: EditPetInfoDialog({
      cancel: () => {
        this.showEditDialog = false
      },
      confirm: (data: PetData) => {
        this.postSavePetData(data)
      },
    }),
  });

  promptAction = this.getUIContext().getPromptAction()

  aboutToAppear(): void {
    this.getPetInfo()
    this.getPetHealthRecords()
  }

  build() {
    Row(){

      Stack({ alignContent: Alignment.TopStart }) {
        // èƒŒæ™¯å›¾
        Image($r("app.media.bg2"))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
          .objectRepeat(ImageRepeat.NoRepeat)


        // ä¸»ä½“å†…å®¹
        Column(){
          Column() {
            Text('å® ç‰©æ¡£æ¡ˆ')
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getTitleColor())
              .margin({ top: 20 })
            Text('å® ç‰©ç®¡ç†ä¸åŸºç¡€ä¿¡æ¯')
              .fontColor(this.getSubTextColor())
              .fontSize(14)
          }
          .padding({ bottom:"16px" })
          if (this.pet.petName){
            Column() {
              Text('åŸºç¡€èµ„æ–™')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .margin({ top: 10, left: 10 })

              // æ”¹ä¸ºGridç½‘æ ¼å¸ƒå±€
              Grid() {
                GridItem() { this.buildInfoRow('åå­—', this.pet.petName) }
                GridItem() { this.buildInfoRow('å‡ºç”Ÿæ—¥æœŸ', this.pet.birthDate) }
                GridItem() { this.buildInfoRow('ç§ç±»', this.pet.petSpecies) }
                GridItem() { this.buildInfoRow('ä½“é‡(kg)', this.pet.currentWeight?.toString()) }
                GridItem() { this.buildInfoRow('æ€§åˆ«', this.pet.petGender) }
                GridItem() { this.buildInfoRow('å¥åº·çŠ¶æ€', this.pet.healthStatus) }
              }
              .columnsTemplate('2fr 2fr') // è®¾ç½®2åˆ—å¸ƒå±€
              .rowsGap(12)                // è¡Œé—´è·
              .columnsGap(20)             // åˆ—é—´è·
              .padding(10)
              .onClick(() =>{
                this.showEditDialog = true
                if (this.showEditDialog) {
                  this.dialogController.open()
                }
              })

            }
            .width('90%')
            .height('20%')
            .backgroundColor($r('sys.color.interactive_select'))
            .borderRadius(10)
            .margin(10)
          }
          Scroll() {
            Column() {
              // åŒ»ç–—ä¸ç–«è‹—ä¿¡æ¯
              Column() {
                Text('åŒ»ç–—è®°å½•ä¸ç–«è‹—ä¿¡æ¯')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 10, left: 10 })

                // åˆ—è¡¨æ˜¾ç¤ºå® ç‰©å¥åº·è®°å½•
                ForEach(this.healthList, (record: PetHealthHistory) => {
                  Column() {
                    Text(`è®°å½•æ—¥æœŸï¼š${record.recordDate ?? '--'}`)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(this.getTextColor())
                    this.buildInfoRow('ä½“é‡(kg)', record.bodyWeight)
                    this.buildInfoRow('ä½“æ¸©(â„ƒ)', record.bodyTemperature)
                    this.buildInfoRow('å¿ƒç‡', record.heartRate)
                    this.buildInfoRow('é£Ÿæ¬²', record.appetiteLevel)
                    this.buildInfoRow('ç²¾åŠ›', record.energyLevel)
                    this.buildInfoRow('ç–«è‹—æ¥ç§', record.vaccinationStatus)
                    this.buildInfoRow('ä¸Šæ¬¡æ¥ç§æ—¥æœŸ', record.lastVaccinationDate)
                    this.buildInfoRow('é©±è™«çŠ¶æ€', record.dewormingStatus)
                    this.buildInfoRow('ä¸Šæ¬¡é©±è™«æ—¥æœŸ', record.lastDewormingDate)
                    this.buildInfoRow('å…½åŒ»å¤‡æ³¨', record.vetNotes)
                  }
                  .width('95%')
                  .backgroundColor('#99ffffff')
                  .borderRadius(8)
                  .padding(10)
                  .margin({ bottom: 10 })
                })
              }
              .width('90%')
              .backgroundColor($r('sys.color.interactive_select'))
              .borderRadius(10)
              .margin(10)

              // è¡Œä¸ºç‰¹å¾ä¸åå¥½
              Column() {
                Text('è¡Œä¸ºç‰¹å¾ä¸åå¥½')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 10, left: 10 })
                Text('ğŸ¾ å–œæ¬¢å®‰é™ã€æ€•é™Œç”Ÿäººï¼Œå¯¹é¸¡è‚‰è¿‡æ•ã€‚')
                  .fontColor(this.getTextColor())
                  .fontSize(14)
                  .margin({ left: 15, top: 5, bottom: 10 })
              }
              .width('90%')
              .backgroundColor($r('sys.color.interactive_select'))
              .borderRadius(10)
              .margin(10)
            }
          }
          .width('100%')
          .height('80%')
          // .padding({ top: '10%' })
        }
      }
      .width('100%')
      .height('100%')
    }

  }

  // ==================
  // å°è£…UIè¾…åŠ©å‡½æ•°
  // ==================
@Builder
  buildInfoRow(label: string, value?: string): void {
    Row() {
      Text(`${label}ï¼š`)
        .fontColor(this.getTextColor())
        .fontWeight(FontWeight.Medium)
        .fontSize(14)
      Text(value ?? '--')
        .fontColor(this.getValueColor())
        .fontWeight(FontWeight.Bold)
        .fontSize(14)
    }
    .justifyContent(FlexAlign.Start)
    .width('100%')
  }

  // ==================
  // ç½‘ç»œè¯·æ±‚éƒ¨åˆ†
  // ==================

  getPetInfo() {
    this.isLoading = true
    let result = new HttpUtil().httpRequestGet<ResponseBean<PetBean[]>>(
      "https://place.wxtcc.com.cn/officelease/pets/getPets",
      [
        { key: "key", value: "803fb55ae18f4ebebe0370cac63492ff" },
        { key: "userId", value: "1" }
      ]
    )
    result.then((value: ResponseBean<PetBean[]>) => {
      if (value?.data?.length) {
        this.pet = value.data[0]
        console.info(`[PetInfo] ${JSON.stringify(this.pet)}`)

      }
      console.info(`[PetInfo] ${JSON.stringify(value)}`)
    }).finally(() => {
      this.isLoading = false
    })
  }

  formatTime(date: Date): string {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hour = date.getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');

    // æŒ‰ç…§ä½ æŒ‡å®šçš„æ ¼å¼ï¼šyyyy-HH-dd hh:mm
    return `${year}-${month}-${day} ${hour}:${minute}`;
  }

  getTimeByOffset(s: number): string {
    const now = new Date();
    now.setSeconds(now.getSeconds() + s);
    return this.formatTime(now);
  }

  // è·å–å½“å‰æ—¶é—´
  getNowTime(): string {
    const now = new Date();
    return this.formatTime(now);
  }

  getPetHealthRecords() {
    this.isLoading = true
    let result = new HttpUtil().httpRequestGet<ResponseBean<DataListBean<PetHealthHistory>>>(
      "https://place.wxtcc.com.cn/officelease/pets/getPetHealthHistory",
      [
        { key: "key", value: "803fb55ae18f4ebebe0370cac63492ff" },
        { key: "petId", value: "1" },
        { key: "startTime", value: this.getTimeByOffset(-1 * 60 * 60 * 24 * 7) },
        { key: "endTime", value: this.getNowTime() },
        { key: "page", value: "1" },
        { key: "size", value: "50" }
      ]
    )

    result.then((value: ResponseBean<DataListBean<PetHealthHistory>>) => {
      const list = value?.data?.list ?? []
      this.healthList = list
      console.info(`[HealthRecord] ${JSON.stringify(value)}`)
    }).finally(() => {
      this.isLoading = false
    })
  }
  postSavePetData(petData: PetData) {
    let result = new HttpUtil().httpRequestPost<ResponseBean<string>>(
      "https://place.wxtcc.com.cn/officelease/pets/updatePets",
      "" ,
      [
        { key: "key", value:  "803fb55ae18f4ebebe0370cac63492ff" },
        { key: "petName", value: petData.petName || "" },
        { key: "petSpecies", value: petData.petSpecies || "" },
        { key: "petBreed", value: petData.petBreed || "" },
        { key: "petGender", value: petData.petGender || "" },
        { key: "birthDate", value: petData.birthDate || "" },
        { key: "currentweight", value: petData.currentWeight?.toString() || "" },
        { key: "healthstatus", value: petData.healthStatus || "" },
        { key: "id", value: "1" },
        { key: "userId", value: "1" }
      ]
    )
    result.then((value: ResponseBean<string>) => {
      this.promptAction.showToast({ message: "ğŸ¾ å® ç‰©ä¿¡æ¯å·²ä¿å­˜æˆåŠŸï¼" })
      setTimeout(() => {
        this.getPetInfo()
      }, 1500)
    })
  }


  // ==================
  // æ ·å¼å°è£…
  // ==================
  private getTextColor(): ResourceColor {
    return '#444444'
  }

  private getTitleColor(): ResourceColor {
    return '#1a1a1a'
  }

  private getSubTextColor(): ResourceColor {
    return '#777777'
  }

  private getValueColor(): ResourceColor {
    return '#0066CC'
  }
}

export class PetData {
  constructor(
    petName?: string,
    birthDate?: string,
    petSpecies?: string,
    petBreed?: string,
    currentWeight?: string,
    petGender?: string,
    healthStatus?: string,

  ) {
    this.petName = petName
    this.birthDate = birthDate
    this.petSpecies = petSpecies
    this.petBreed = petBreed
    this.currentWeight = currentWeight
    this.petGender = petGender
    this.healthStatus = healthStatus

  }

  petName?: string = ''
  birthDate?: string = ''
  petSpecies?: string = ''
  petBreed?: string = ''
  currentWeight?: string = ''
  petGender?: string = ''
  healthStatus?: string = ''

}

@CustomDialog
struct EditPetInfoDialog {
  @State petName: string = ''
  @State birthDate: string = ''
  @State petSpecies: string = ''
  @State petBreed: string = ''
  @State currentWeight: string = ''
  @State petGender: string = ''
  @State healthStatus: string = ''

  cancel: () => void = () => {}
  confirm: (data: PetData) => void = (data: PetData) => {}
  controller: CustomDialogController

  build() {
    Column({ space: 18 }) {
      Text('âœï¸ ç¼–è¾‘å® ç‰©åŸºç¡€ä¿¡æ¯')
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 10 })

      this.inputField('ğŸ¶ åå­—', 'è¯·è¾“å…¥å® ç‰©åå­—', (v) => this.petName = v)
      this.inputField('ğŸ‚ å‡ºç”Ÿæ—¥æœŸ', 'ä¾‹å¦‚ 2023-05-10', (v) => this.birthDate = v)
      this.inputField('ğŸ• ç§ç±»', 'ä¾‹å¦‚ é‡‘æ¯› / çŒ«å’ª', (v) => this.petSpecies = v)
      this.inputField('ğŸ¾ å“ç§', 'ä¾‹å¦‚ æ¯”ç†Š / è‹±çŸ­ / ç”°å›­çŒ«', (v) => this.petBreed = v)
      this.inputField('âš–ï¸ ä½“é‡(kg)', 'è¯·è¾“å…¥æ•°å­—', (v) => this.currentWeight = v, InputType.Number)
      this.inputField('ğŸš» æ€§åˆ«', 'é›„æ€§ / é›Œæ€§', (v) => this.petGender = v)
      this.inputField('â¤ï¸ å¥åº·çŠ¶æ€', 'è‰¯å¥½ / éœ€è¦å…³æ³¨', (v) => this.healthStatus = v)

      Row({ space: 20 }) {
        Button('å–æ¶ˆ')
          .width('40%')
          .height(44)
          .backgroundColor('#ccc')
          .fontColor('#000')
          .borderRadius(10)
          .onClick(() => {
            this.controller.close()
            this.cancel()
          })

        Button('ä¿å­˜')
          .width('40%')
          .height(44)
          .backgroundColor('#007DFF')
          .fontColor('#fff')
          .borderRadius(10)
          .onClick(() => {
            if (!this.petName) {
              prompt.showToast({ message: 'è¯·è¾“å…¥å® ç‰©åå­—' })
              return
            }
            const data = new PetData()
            data.petName = this.petName
            data.birthDate = this.birthDate
            data.petSpecies = this.petSpecies
            data.petBreed = this.petBreed
            data.currentWeight = this.currentWeight
            data.petGender = this.petGender
            data.healthStatus = this.healthStatus

            this.controller.close()
            this.confirm(data)
          })
      }
      .margin({ top: 20 })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#fff')
    .borderRadius(12)
  }

  @Builder
  inputField(label: string, placeholder: string, onChange: (v: string) => void, type: InputType = InputType.Normal) {
    Column() {
      Text(label).fontSize(16)
      TextInput({ placeholder: placeholder })
        .width('90%')
        .height(40)
        .type(type)
        .backgroundColor('#f5f5f5')
        .borderRadius(6)
        .onChange(onChange)
    }
  }
}
